pkg: gcc/10.2.0

sources:
  - tar: http://ftpmirror.gnu.org/gnu/gcc/gcc-10.2.0/gcc-10.2.0.tar.xz
  - tar: http://ftpmirror.gnu.org/gnu/mpfr/mpfr-4.1.0.tar.xz
  - tar: http://ftpmirror.gnu.org/gnu/gmp/gmp-6.2.1.tar.xz
  - tar: http://ftpmirror.gnu.org/gnu/mpc/mpc-1.2.1.tar.gz
  - script:
    - mv -v mpfr-4.1.0 gcc-10.2.0/mpfr
    - mv -v gmp-6.2.1 gcc-10.2.0/gmp
    - mv -v mpc-1.2.1 gcc-10.2.0/mpc

build:
  options:
    - var: bootstrap
      static: yes
    - var: target/x86_64-pc-linux-gnu
    - var: binutils.bootrap/yes
    - pkg: binutils
      inheritance: Strong
    - pkg: glibc
      inheritance: Strong
    - pkg: stdfs
      inheritance: Strong
  script:
    - cd gcc-10.2.0
    # set the default lib to to just `lib`
    - sed -e '/m64=/s/lib64/lib/' -i gcc/config/i386/t-linux64
    # allow posix thread support
    - mkdir -pv $SPK_OPT_target/libgcc
    - ln -s ../../../libgcc/gthr-posix.h $SPK_OPT_target/libgcc/gthr-default.h
    - mkdir -p build; cd build
    - unset LIBRARY_PATH # this is specifically checked for during build
    # TODO: get target from build options
    - ../configure
      --build=$(../config.guess)
      --target=$SPK_OPT_target
      --prefix=/spfs
      --with-glibc-version=2.11
      --with-sysroot=/spfs
      --with-local-prefix=/spfs
      --with-build-sysroot=/spfs
      --enable-initfini-array
      CC_FOR_TARGET=$SPK_OPT_target-gcc
      --with-newlib
      --without-headers
      --enable-initfini-array
      --disable-nls
      --disable-shared
      --disable-multilib
      --disable-decimal-float
      --disable-threads
      --disable-libatomic
      --disable-libgomp
      --disable-libquadmath
      --disable-libssp
      --disable-libvtv
      --disable-libstdcxx
      --disable-bootstrap
      --enable-languages=c,c++
    - make -j$(nproc)
    - make check
    - make install
    - ln -sv gcc /spfs/bin/cc

tests:
  - stage: install
    script:
      - echo "int main(){}" > test.c
      - /spfs/bin/*-gcc test.c -o test.o
      - readelf -l test.o | grep '/ld-linux'

install:
  requirements:
    - pkg: stdfs
    - pkg: glibc
    - pkg: binutils
